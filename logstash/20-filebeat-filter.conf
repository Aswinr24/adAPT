# ============================================================================
# Filebeat Module Tagging Filter
# Purpose: Tag logs by module for downstream processing
# ============================================================================

filter {
  # Tag by filebeat module
  if [event][module] == "system" or "system" in [fileset][module] {
    mutate { 
      add_field => { "log_type" => "system" }
      add_tag => ["filebeat_system"]
    }
  }

  if [event][module] == "auditd" or "auditd" in [fileset][module] {
    mutate { 
      add_field => { "log_type" => "auditd" }
      add_tag => ["filebeat_auditd"]
    }
  }

  if [event][module] == "zeek" {
    mutate {
      add_field => { "log_type" => "zeek" }
      add_tag => ["filebeat_zeek", "network_traffic"]
    }
  }

  # Extract source/destination IPs from various log formats
  # This ensures GeoIP and Threat Intel filters can process them
  
  # For system auth logs - extract IPs from SSH
  if [log_type] == "system" and [message] =~ /sshd/ {
    grok {
      match => { "message" => "from %{IP:[source][ip]}" }
      tag_on_failure => []
    }
  }
}