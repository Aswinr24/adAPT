filter {
  if [type] == "pfsense" {

    # ----- ECS REQUIRED FIELDS -----
    mutate {
      add_field => {
        "[ecs][version]"       => "8.11.0"
        "[event][kind]"        => "event"
        "[event][category]"    => "network"
        "[event][type]"        => "connection"
        "[event][dataset]"     => "pfsense.firewall"
        "[event][module]"      => "pfsense"
        "[observer][vendor]"   => "Netgate"
        "[observer][product]"  => "pfSense"
        "[observer][type]"     => "firewall"
      }
    }

    # ----- ECS FIELD MAPPING -----
    mutate {
      rename => {
        "src_ip"       => "[source][ip]"
        "dst_ip"       => "[destination][ip]"
        "src_port"     => "[source][port]"
        "dst_port"     => "[destination][port]"
        "protocol"     => "[network][transport]"
        "protocol_id"  => "[network][iana_number]"
        "action"       => "[event][action]"
        "reason"       => "[event][reason]"
        "direction"    => "[network][direction]"
        "interface"    => "[observer][ingress][interface][name]"
        "rule_number"  => "[rule][id]"
      }
      convert => {
        "[source][port]" => "integer"
        "[destination][port]" => "integer"
        "[network][iana_number]" => "integer"
      }
      lowercase => [ "[network][transport]", "[event][action]", "[network][direction]" ]
    }

    # ----- IP VERSION â†’ network.protocol -----
    if [ip_version] == "4" {
      mutate { add_field => { "[network][protocol]" => "ipv4" } }
    }
    if [ip_version] == "6" {
      mutate { add_field => { "[network][protocol]" => "ipv6" } }
    }

    # ----- OUTCOME MAPPING -----
    if [event][action] == "pass" {
      mutate {
        replace => { "[event][action]" => "allowed" }
        add_field => { "[event][outcome]" => "success" }
      }
    }

    if [event][action] == "block" {
      mutate {
        replace => { "[event][action]" => "denied" }
        add_field => { "[event][outcome]" => "failure" }
      }
    }
  }
}
